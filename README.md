# iGuide HAND Dam Workflow

This repository contains Python scripts for Height Above Nearest Drainage (HAND) inundation mapping workflow for aging dams. The workflow combines HUC12 watershed analysis with TauDEM hydrologic processing to generate flood inundation maps.

## Overview

### dam_catchments.py

This script calculates bounding boxes for all HUC12 watersheds downstream from a dam location. Key features include:

- **Dam Location Analysis**: Finds the starting HUC12 watershed containing the dam location
- **Downstream Traversal**: Follows HUC12 connectivity data to identify all downstream watersheds
- **Distance Calculation**: Uses sqrt(area) formula to calculate cumulative distance along the flow path
- **Automatic Termination**: Stops at 100km distance or closed basins (terminal watersheds)
- **Bounding Box Computation**: Calculates spatial bounds in the target raster projection
- **Raster Clipping**: Optionally clips all NHDPlus rasters to the calculated bounding box with optional buffer

The script outputs downstream HUC12 shapefiles, bounding box coordinates, and optionally clipped rasters for efficient processing.

### dam_hand.py

This script implements the HAND (Height Above Nearest Drainage) calculation workflow. Key components include:

- **Data Preparation**: Copies and preprocesses clipped rasters and input files
- **Flow Direction Processing**: Creates flow direction masks and reclassifies ArcGIS D8 to TauDEM encoding
- **TauDEM Integration**: Runs TauDEM tools for pit removal, flow direction, and contributing area calculations
- **HAND Calculation**: Computes Height Above Nearest Drainage using D-infinity distance-down method
- **Stream Network Analysis**: Generates stream networks and processes outlet locations
- **Catchment Processing**: Creates catchment lists for hydraulic analysis

The workflow produces HAND rasters, stream networks, and catchment data required for inundation analysis.

### dam_inundation.py

This script performs inundation analysis using the HAND data generated by `dam_hand.py`. Key features include:

- **Input Validation**: Verifies all required HAND workflow outputs are available
- **Hydraulic Geometry**: Calculates hydraulic properties for stream reaches
- **Inundation Mapping**: Computes flood inundation depths using forecast data
- **Results Output**: Generates inundation rasters and depth summary tables

This modular approach allows for running inundation analysis multiple times with different scenarios without re-running the entire HAND workflow.

## Installation

### Prerequisites

Before installing Python dependencies, ensure you have the following external tools installed:

- **TauDEM** (Terrain Analysis Using Digital Elevation Models) - C++ tools for hydrologic analysis
- **MPI** (Message Passing Interface) - Required for TauDEM parallel processing
- **GDAL** command line tools - For raster processing operations

### Python Environment Setup

1. **Create a Python virtual environment**:

   ```bash
   # On macOS/Linux:
   python3 -m venv .venv
   ```

   ```bash
   # On Windows:
   python -m venv .venv --system-site-packages
   ```

   **NOTE**: The `--system-site-packages` flag is important in Windows to ensure that the virtual environment has access to the external tools (e.g., GDAL) installed on the system.

2. **Activate the virtual environment**:

   ```bash
   # On macOS/Linux:
   source .venv/bin/activate

   # On Windows:
   .venv\Scripts\activate
   ```

   **CHECK**: On Windows after activating the virtual environment, run `pip list` to verify that the GDAL is in the list of installed packages. If not, you need to install it manually. You can try this [tool](https://pypi.org/project/gdal-installer/) to install GDAL.

3. **Install Python dependencies**:

   ```bash
   # On macOS/Linux:
   pip install -r requirements.txt

   # On Windows:
   pip install -r win-requirements.txt
   ```

   **NOTE**: The Windows requirements file does not include Python bindings for GDAL installation. We assume Python bindings for GDAL is already installed on the system as part of the TauDEM installation (ArcGIS TauDEM tools).

4. **Verify installation**:

   ```bash
   python -c "import geopandas, rasterio, numpy, pandas; print('All dependencies installed successfully!')"
   ```

## Computing HUC12 Bounding Box and Clipping HUC12 Rasters

The `dam_catchments.py` script calculates downstream watershed boundaries and optionally clips rasters to reduce processing area.

### Basic Usage with Raster Clipping

   ```bash
   python src/dam_catchments.py --clip-rasters --buffer 4000
   ```

This command will:

- Calculate the bounding box for all HUC12 watersheds downstream from the dam location
- Clip all NHDPlus rasters to the calculated bounding box
- Add a 4000-meter buffer around the bounding box before clipping
- Save clipped rasters to `outputs/clipped/` directory
- Generate processing reports and downstream HUC12 shapefiles

### Output Files

- `outputs/downstream_huc12s_from_dam.shp` - Downstream HUC12 watersheds shapefile
- `outputs/bounding_box_coordinates.txt` - Bounding box coordinates in target projection
- `outputs/processing_report.txt` - Detailed processing summary
- `outputs/clipped/` - Directory containing clipped raster files

## HAND Workflow

The HAND workflow is now split into two scripts for better modularity:

### 1. HAND Data Generation

The `dam_hand.py` script executes the HAND calculation workflow using TauDEM tools.

#### Basic Usage

   ```bash
   python src/dam_hand.py --taudem-path /path/to/taudem
   ```

This command will:

- Copy clipped rasters and input files to the working directory
- Process flow directions and elevation data
- Run TauDEM hydrologic analysis tools
- Calculate HAND (Height Above Nearest Drainage) values
- Generate stream networks and process outlet locations
- Create catchment lists for hydraulic analysis

### 2. Inundation Analysis

The `dam_inundation.py` script performs flood inundation analysis using the HAND data.

#### Basic Usage

```bash
python src/dam_inundation.py --taudem-path /path/to/taudem
```

This command will:

- Validate that all required HAND workflow outputs exist
- Calculate hydraulic geometry for stream reaches
- Compute inundation depths using forecast data
- Generate flood inundation maps and depth summaries

### Prerequisites for HAND Workflow

Before running the HAND workflow, ensure you have:

1. **Completed HUC12 bounding box calculation** with `--clip-rasters` option
2. **TauDEM installed** and accessible at the specified path
3. **Required input files** in the `data/` directory:
   - `stage.txt` - Stage height data
   - `forecast.csv` - Forecast data
   - `Outlets2_utm.shp` - Outlet locations shapefile
   - Dam location shapefile and HUC12 geodatabase

### HAND Workflow Output Files

The workflow generates numerous output files including:

**From dam_hand.py:**

- `hand.tif` - Height Above Nearest Drainage raster
- `w2.tif` - Catchment raster
- `catchlist.csv` - Catchment properties list
- `slp.tif` - Slope raster
- Various intermediate TauDEM processing files

**From dam_inundation.py:**

- `hydroprop.csv` - Hydraulic properties table
- `inundepth.tif` - Inundation depth raster
- `depths.csv` - Depth calculations summary

## Directory Structure

```text
iguide-hand/
├── src/
│   ├── dam_catchments.py
│   ├── dam_hand.py
│   ├── dam_inundation.py
│   ├── utils.py
│   └── ...
├── data/
│   ├── mountain_dell_dam_location.shp
│   ├── NHDPLUS_H_1602_HU4_20220412_GDB/
│   ├── NHDPLUS_H_1602_HU4_20220412_RASTER/
│   ├── stage.txt
│   ├── forecast.csv
│   └── Outlets2_utm.shp
├── outputs/
│   ├── clipped/          # Clipped rasters
│   ├── hand.tif          # HAND results
│   ├── inundepth.tif     # Inundation depths
│   └── ...
├── requirements.txt
├── win-requirements.txt  # For Windows
└── README.md
```

## Workflow Sequence

For a complete analysis, run the scripts in the following order:

1. **First**, calculate bounding box and clip rasters:

   ```bash
   python src/dam_catchments.py --clip-rasters --buffer 4000
   ```

2. **Second**, run the HAND calculation workflow:

   ```bash
   python src/dam_hand.py --taudem-path /usr/local/taudem
   ```

3. **Third**, run the inundation analysis:

   ```bash
   python src/dam_inundation.py --taudem-path /usr/local/taudem
   ```

4. **Finally**, deactivate the virtual environment when finished:

   ```bash
   deactivate
   ```

This sequence ensures efficient processing by:

- Operating on clipped data to reduce computational requirements
- Separating HAND calculation from inundation analysis for modularity
- Allowing multiple inundation scenarios without re-running HAND calculations

## Support

For questions or issues related to this workflow, please refer to the processing reports generated by each script, which contain detailed logs and diagnostic information.
