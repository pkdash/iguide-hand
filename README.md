# iGuide HAND Dam Workflow

This repository contains Python scripts for Height Above Nearest Drainage (HAND) inundation mapping workflow for aging dams. The workflow combines HUC12 watershed analysis with TauDEM hydrologic processing to generate flood inundation maps.

## Overview

### dam_catchments.py

This script calculates bounding boxes for all HUC12 watersheds downstream from a dam location. Key features include:

- **Dam Location Analysis**: Finds the starting HUC12 watershed containing the dam location
- **Downstream Traversal**: Follows HUC12 connectivity data to identify all downstream watersheds
- **Distance Calculation**: Uses sqrt(area) formula to calculate cumulative distance along the flow path
- **Automatic Termination**: Stops at 100km distance or closed basins (terminal watersheds)
- **Bounding Box Computation**: Calculates spatial bounds in the target raster projection
- **Raster Clipping**: Optionally clips all NHDPlus rasters to the calculated bounding box with optional buffer

The script outputs downstream HUC12 shapefiles, bounding box coordinates, and optionally clipped rasters for efficient processing.

### dam_hand.py

This script implements the HAND (Height Above Nearest Drainage) calculation workflow. Key components include:

- **Data Preparation**: Copies and preprocesses clipped rasters and input files
- **Flow Direction Processing**: Creates flow direction masks and reclassifies ArcGIS D8 to TauDEM encoding
- **TauDEM Integration**: Runs TauDEM tools for pit removal, flow direction, and contributing area calculations
- **HAND Calculation**: Computes Height Above Nearest Drainage using D-infinity distance-down method
- **Stream Network Analysis**: Generates stream networks and processes outlet locations
- **Catchment Processing**: Creates catchment lists for hydraulic analysis

The workflow produces HAND rasters, stream networks, and catchment data required for inundation analysis.

### dam_inundation.py

This script performs inundation analysis using the HAND data generated by `dam_hand.py`. Key features include:

- **Input Validation**: Verifies all required HAND workflow outputs are available
- **Hydraulic Geometry**: Calculates hydraulic properties for stream reaches
- **Inundation Mapping**: Computes flood inundation depths using forecast data
- **Results Output**: Generates inundation rasters and depth summary tables

This modular approach allows for running inundation analysis multiple times with different scenarios without re-running the entire HAND workflow.

## Installation and Usage

### Prerequisites

The HAND workflow requires TauDEM 5.4.0 or later. Make sure to install TauDEM and its dependencies before proceeding.

### For End Users

If you just want to use the iGuide HAND workflow tools, you can install them using `uv` (recommended) or `pip`.

#### Option 1: Using uv (Recommended)

1. **Install uv** (if not already installed):
   ```bash
   curl -LsSf https://astral.sh/uv/install.sh | sh
   ```

2. **Create a new project and install iguide-hand**:
   ```bash
   uv init my-dam-analysis
   cd my-dam-analysis
   uv add git+https://github.com/pkdash/iguide-hand.git
   ```

3. **Run the scripts**:
   ```bash
   # Calculate bounding box and clip rasters
   uv run dam_catchments --clip-rasters --buffer 4000
   
   # Run HAND calculation workflow
   uv run dam_hand --taudem-path /usr/local/taudem
   
   # Run inundation analysis
   uv run dam_inundation --taudem-path /usr/local/taudem
   ```

#### Option 2: Using pip

1. **Create and activate a virtual environment**:
   ```bash
   python -m venv venv
   source venv/bin/activate  # On Windows: venv\Scripts\activate
   ```

2. **Install iguide-hand**:
   ```bash
   pip install git+https://github.com/pkdash/iguide-hand.git
   ```

3. **Run the scripts**:
   ```bash
   python -m dam_catchments --clip-rasters --buffer 4000
   python -m dam_hand --taudem-path /usr/local/taudem
   python -m dam_inundation --taudem-path /usr/local/taudem
   ```

#### Option 3: Quick Testing (No Installation)

For quick testing without installation, you can clone the repository and use `uv run`:

```bash
git clone https://github.com/pkdash/iguide-hand.git
cd iguide-hand
uv sync
uv run dam_catchments --help
```

### Data Setup

Before running the workflow, ensure you have the required data files in the `data/` directory:

- Dam location shapefile
- HUC12 geodatabase from NHDPlus
- NHDPlus raster files
- `stage.txt` - Stage height data
- `forecast.csv` - Forecast data
- `Outlets2_utm.shp` - Outlet locations shapefile

## Development Setup

### For Developers

If you want to contribute to the iGuide HAND workflow or modify the code, follow these steps:

#### Prerequisites for Development

- Python 3.11 or later
- Git
- TauDEM 5.4.0 or later
- uv (recommended) or pip

#### Setup Development Environment

1. **Clone the repository**:
   ```bash
   git clone https://github.com/pkdash/iguide-hand.git
   cd iguide-hand
   ```

2. **Set up development environment with uv (Recommended)**:
   ```bash
   # Sync dependencies and set up virtual environment automatically
   uv sync
   ```

3. **Alternative: Set up with pip**:
   ```bash
   # Create virtual environment
   python -m venv .venv
   
   # Activate virtual environment
   source .venv/bin/activate  # On Windows: .venv\Scripts\activate
   
   # Install in editable mode
   pip install -e .
   ```

4. **Verify installation**:
   ```bash
   python -c "import geopandas, rasterio, numpy, pandas; print('All dependencies installed successfully!')"
   ```

#### Development Workflow

1. **Make your changes** to the source code in the `src/` directory

2. **Test your changes**:
   ```bash
   # Run the scripts directly during development using python
   python src/dam_catchments.py --help
   python src/dam_hand.py --help
   python src/dam_inundation.py --help

   # Or use uv run
   uv run src/dam_catchments.py --help
   uv run src/dam_hand.py --help
   uv run src/dam_inundation.py --help
   ```

3. **Add tests** (if applicable) and ensure existing functionality works

4. **Commit and push your changes**:
   ```bash
   git add .
   git commit -m "Description of your changes"
   git push origin your-feature-branch
   ```

#### Code Style and Quality

This project follows standard Python conventions. When contributing:

- Follow PEP 8 style guidelines
- Add docstrings to new functions and classes
- Include type hints where appropriate
- Update documentation as needed

#### Project Structure for Developers

```text
iguide-hand/
├── src/                  # Source code
│   ├── dam_catchments.py # HUC12 analysis and raster clipping
│   ├── dam_hand.py      # HAND calculation workflow
│   ├── dam_inundation.py # Inundation analysis
│   └── utils.py         # Utility functions
├── data/                # Input data files (not in repo)
├── outputs/             # Generated output files
├── tests/               # Unit tests (future)
├── pyproject.toml       # Project configuration and dependencies
├── README.md           # This file
└── .gitignore          # Git ignore rules
```

## Computing HUC12 Bounding Box and Clipping HUC12 Rasters

The `dam_catchments.py` script calculates downstream watershed boundaries and optionally clips rasters to reduce processing area.

### Basic Usage with Raster Clipping

   ```bash
   uv run dam_catchments --clip-rasters --buffer 4000
   ```

This command will:

- Calculate the bounding box for all HUC12 watersheds downstream from the dam location
- Clip all NHDPlus rasters to the calculated bounding box
- Add a 4000-meter buffer around the bounding box before clipping
- Save clipped rasters to `outputs/clipped/` directory
- Generate processing reports and downstream HUC12 shapefiles

### Output Files

- `outputs/downstream_huc12s_from_dam.shp` - Downstream HUC12 watersheds shapefile
- `outputs/bounding_box_coordinates.txt` - Bounding box coordinates in target projection
- `outputs/processing_report.txt` - Detailed processing summary
- `outputs/clipped/` - Directory containing clipped raster files

## HAND Workflow

The HAND workflow is now split into two scripts for better modularity:

### 1. HAND Data Generation

The `dam_hand.py` script executes the HAND calculation workflow using TauDEM tools.

#### Basic Usage

   ```bash
   uv run dam_hand --taudem-path /path/to/taudem
   ```

This command will:

- Copy clipped rasters and input files to the working directory
- Process flow directions and elevation data
- Run TauDEM hydrologic analysis tools
- Calculate HAND (Height Above Nearest Drainage) values
- Generate stream networks and process outlet locations
- Create catchment lists for hydraulic analysis

### 2. Inundation Analysis

The `dam_inundation.py` script performs flood inundation analysis using the HAND data.

#### Basic Usage

```bash
uv run dam_inundation --taudem-path /path/to/taudem
```

This command will:

- Validate that all required HAND workflow outputs exist
- Calculate hydraulic geometry for stream reaches
- Compute inundation depths using forecast data
- Generate flood inundation maps and depth summaries

### Prerequisites for HAND Workflow

Before running the HAND workflow, ensure you have:

1. **Completed HUC12 bounding box calculation** with `--clip-rasters` option
2. **TauDEM installed** and accessible at the specified path
3. **Required input files** in the `data/` directory:
   - `stage.txt` - Stage height data
   - `forecast.csv` - Forecast data
   - `Outlets2_utm.shp` - Outlet locations shapefile
   - Dam location shapefile and HUC12 geodatabase

### HAND Workflow Output Files

The workflow generates numerous output files including:

**From dam_hand.py:**

- `hand.tif` - Height Above Nearest Drainage raster
- `w2.tif` - Catchment raster
- `catchlist.csv` - Catchment properties list
- `slp.tif` - Slope raster
- Various intermediate TauDEM processing files

**From dam_inundation.py:**

- `hydroprop.csv` - Hydraulic properties table
- `inundepth.tif` - Inundation depth raster
- `depths.csv` - Depth calculations summary

## Workflow Sequence

For a complete analysis, run the scripts in the following order:

1. **First**, calculate bounding box and clip rasters:

   ```bash
   uv run dam_catchments --clip-rasters --buffer 4000
   ```

2. **Second**, run the HAND calculation workflow:

   ```bash
   uv run dam_hand --taudem-path /usr/local/taudem
   ```

3. **Third**, run the inundation analysis:

   ```bash
   uv run dam_inundation --taudem-path /usr/local/taudem
   ```

4. **Finally**, if not using `uv`, deactivate the virtual environment when finished:

   ```bash
   deactivate
   ```

This sequence ensures efficient processing by:

- Operating on clipped data to reduce computational requirements
- Separating HAND calculation from inundation analysis for modularity
- Allowing multiple inundation scenarios without re-running HAND calculations

## Support

For questions or issues related to this workflow, please refer to the processing reports generated by each script, which contain detailed logs and diagnostic information.
